# Automated NuGet Package Updates using dotnet-outdated-tool
#
# This workflow automatically checks for and updates outdated NuGet packages.
# Runs every Saturday at 9 AM UTC
#
# IMPORTANT - Central Package Management (CPM):
# This repository uses Directory.Packages.props for central package management.
# The workflow will:
# 1. Automatically detect and update Directory.Packages.props
# 2. Apply updates to ALL projects (since they share the same version file)
# 3. Create a PR with detailed update information
#
# This ensures version consistency across all projects in the repository.

name: Update NuGet Packages

on:
  schedule:
    - cron: '0 9 * * 6'  # Every Saturday at 9 AM UTC
  workflow_dispatch:      # Allow manual triggering

env:
  DOTNET_VERSION: '8.0.x'  # Match the project's .NET version

jobs:
  update-packages:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install dotnet-outdated-tool
        run: |
          dotnet tool install --global dotnet-outdated-tool || dotnet tool update --global dotnet-outdated-tool

      - name: Restore dependencies
        run: dotnet restore

      - name: Check for outdated packages
        id: check-outdated
        run: |
          echo "Checking for outdated NuGet packages..."

          # Run dotnet-outdated and save output
          # Using --fail-on-updates to get exit code 2 when updates are available
          set +e  # Don't exit on non-zero return code
          OUTPUT=$(dotnet-outdated --fail-on-updates 2>&1)
          EXIT_CODE=$?
          set -e

          echo "$OUTPUT"

          # Save the output for later use in PR body
          echo "OUTDATED_OUTPUT<<EOF" >> $GITHUB_ENV
          echo "$OUTPUT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Exit code 2 means updates are available
          if [ $EXIT_CODE -eq 2 ]; then
            echo "‚úÖ Updates available!"
            echo "updates_available=true" >> $GITHUB_OUTPUT

            # Extract package update information for PR body
            echo "$OUTPUT" | grep -E "^\s+\S+\s+\S+\s+->\s+\S+" > /tmp/updates.txt || true
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "‚ÑπÔ∏è No updates found - all packages are up to date"
            echo "updates_available=false" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Error checking for updates (exit code: $EXIT_CODE)"
            exit 1
          fi

      - name: Create update branch
        if: steps.check-outdated.outputs.updates_available == 'true'
        run: |
          BRANCH_NAME="nuget-updates-$(date +%Y%m%d)"
          git checkout -b "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Update packages
        if: steps.check-outdated.outputs.updates_available == 'true'
        id: update
        run: |
          # Update all outdated packages
          # dotnet-outdated will automatically detect and update Directory.Packages.props
          echo "Updating packages to latest versions..."

          # Capture the original state for comparison
          cp Directory.Packages.props /tmp/Directory.Packages.props.original || true

          # Try to upgrade packages, but continue even if some fail
          set +e
          dotnet-outdated --upgrade
          UPGRADE_EXIT_CODE=$?
          set -e

          if [ $UPGRADE_EXIT_CODE -ne 0 ]; then
            echo "‚ö†Ô∏è Some packages may have failed to update, continuing with successfully updated packages..."
            echo "partial_update=true" >> $GITHUB_OUTPUT
          else
            echo "partial_update=false" >> $GITHUB_OUTPUT
          fi

          # Check what actually got updated
          if [ -f /tmp/Directory.Packages.props.original ]; then
            if diff -q /tmp/Directory.Packages.props.original Directory.Packages.props > /dev/null; then
              echo "‚ùå No packages were actually updated"
              echo "packages_updated=false" >> $GITHUB_OUTPUT
              exit 1
            else
              echo "‚úÖ Packages were successfully updated"
              echo "packages_updated=true" >> $GITHUB_OUTPUT
            fi
          fi

          # Restore to verify the updated packages work
          dotnet restore

          # Run a basic build to ensure everything compiles
          echo "Verifying build with updated packages..."
          dotnet build --no-restore

          # Get the list of what was actually updated for the PR
          echo "Checking what was updated..."
          dotnet-outdated > /tmp/post-update-check.txt 2>&1 || true
          echo "POST_UPDATE_CHECK<<EOF" >> $GITHUB_ENV
          cat /tmp/post-update-check.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Configure Git
        if: steps.check-outdated.outputs.updates_available == 'true'
        run: |
          git config user.name "NuGet Update Bot"
          git config user.email "nuget-bot@github-actions"

      - name: Commit changes
        if: steps.check-outdated.outputs.updates_available == 'true'
        id: commit
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            COMMIT_MSG="chore: update NuGet packages

          Automated NuGet package updates by NugetUpdateBot

          Generated on: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git commit -m "$COMMIT_MSG"
            git push origin "${{ env.branch }}"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check-outdated.outputs.updates_available == 'true' && steps.commit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Prepare warning message if partial update
          PARTIAL_WARNING=""
          if [ "${{ steps.update.outputs.partial_update }}" == "true" ]; then
            PARTIAL_WARNING="
          > ‚ö†Ô∏è **Note**: Some packages failed to update. Please review the changes carefully.
          "
          fi

          # Create PR body with actual update details
          PR_BODY="## üîÑ NuGet Package Updates

          This PR contains automatic NuGet package updates generated by dotnet-outdated-tool.
          $PARTIAL_WARNING

          ### üì¶ Package Updates

          **Before Update:**
          \`\`\`
          ${{ env.OUTDATED_OUTPUT }}
          \`\`\`

          **After Update:**
          \`\`\`
          ${{ env.POST_UPDATE_CHECK }}
          \`\`\`

          ### ‚úÖ Checklist
          Please review the changes and ensure:
          - [ ] All tests pass
          - [ ] No breaking changes introduced
          - [ ] Application builds successfully
          - [ ] Package updates are compatible

          ### üìã Generated Information
          - **Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - **Triggered by**: GitHub Actions (Scheduled)
          - **Tool**: [dotnet-outdated-tool](https://github.com/dotnet-outdated/dotnet-outdated)

          ---
          ü§ñ This PR was automatically created by GitHub Actions"

          # Check if PR already exists for today
          EXISTING_PR=$(gh pr list --head "${{ env.branch }}" --json number --jq '.[0].number' || echo "")

          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists (#$EXISTING_PR), updating it..."
            gh pr edit "$EXISTING_PR" --body "$PR_BODY"
          else
            gh pr create \
              --title "üîÑ Update NuGet Packages ($(date +%Y-%m-%d))" \
              --body "$PR_BODY" \
              --base main \
              --head "${{ env.branch }}"
          fi

      - name: No updates needed
        if: steps.check-outdated.outputs.updates_available == 'false'
        run: |
          echo "‚úÖ All packages are up to date!"
