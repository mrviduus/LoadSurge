# Automated NuGet Package Updates using dotnet-outdated-tool
#
# This workflow automatically checks for and updates outdated NuGet packages.
# For LoadSurge: Runs on Saturday at 9 AM UTC
# For xUnitV3LoadFramework: Change cron to '0 9 * * 1' (Monday)
#
# IMPORTANT - Central Package Management (CPM):
# If your repository uses Directory.Packages.props (CPM), dotnet-outdated-tool will:
# 1. Automatically detect CPM
# 2. Update ONLY Directory.Packages.props (not individual .csproj files)
# 3. Apply updates to ALL projects (since they share the same version file)
#
# This ensures version consistency across all projects in the repository.

name: Update NuGet Packages

on:
  schedule:
    - cron: '0 9 * * 6'  # Change this: 1=Monday, 6=Saturday
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  update-packages:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install dotnet-outdated-tool
        run: |
          dotnet tool install --global dotnet-outdated-tool || dotnet tool update --global dotnet-outdated-tool

      - name: Find .csproj files
        id: find-projects
        run: |
          # Find all .csproj files, excluding test projects first, then any project
          MAIN_PROJECT=$(find . -name "*.csproj" ! -path "*/tests/*" ! -path "*/test/*" ! -name "*Test*.csproj" | head -1)
          if [ -z "$MAIN_PROJECT" ]; then
            # If no main project found, use any .csproj file
            MAIN_PROJECT=$(find . -name "*.csproj" | head -1)
          fi
          echo "Found project for scanning: $MAIN_PROJECT"
          echo "project=$MAIN_PROJECT" >> $GITHUB_OUTPUT

      - name: Scan for updates
        id: scan
        run: |
          if [ -n "${{ steps.find-projects.outputs.project }}" ]; then
            echo "Scanning ${{ steps.find-projects.outputs.project }} for updates..."

            # Run dotnet outdated with --upgrade:Major to include ALL updates (major, minor, patch)
            # Exit code 0 = no updates, 1 = updates available, >1 = error
            set +e
            dotnet outdated "${{ steps.find-projects.outputs.project }}" --upgrade:Major
            EXIT_CODE=$?
            set -e

            echo "dotnet outdated exit code: $EXIT_CODE"

            # Exit code 1 means updates are available
            # Exit code 0 means no updates
            # Exit code >1 means error
            if [ $EXIT_CODE -eq 1 ]; then
              echo "âœ… Updates available!"
              echo "updates_available=true" >> $GITHUB_OUTPUT
            elif [ $EXIT_CODE -eq 0 ]; then
              echo "â„¹ï¸ No updates found"
              echo "updates_available=false" >> $GITHUB_OUTPUT
            else
              echo "âŒ Error running dotnet outdated (exit code: $EXIT_CODE)"
              exit $EXIT_CODE
            fi
          else
            echo "âŒ No .csproj files found"
            exit 1
          fi

      - name: Create update branch
        if: steps.scan.outputs.updates_available == 'true'
        run: |
          BRANCH_NAME="nuget-updates-$(date +%Y%m%d)"
          git checkout -b "$BRANCH_NAME"
          echo "branch=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Update packages
        if: steps.scan.outputs.updates_available == 'true'
        run: |
          # dotnet-outdated with --upgrade:Major will update ALL packages (major, minor, patch)
          # It will handle Directory.Packages.props (CPM) automatically
          echo "Updating packages to latest versions..."
          dotnet outdated "${{ steps.find-projects.outputs.project }}" --upgrade:Major

      - name: Configure Git
        if: steps.scan.outputs.updates_available == 'true'
        run: |
          git config user.name "NuGet Update Bot"
          git config user.email "nuget-bot@github-actions"

      - name: Commit changes
        if: steps.scan.outputs.updates_available == 'true'
        id: commit
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            COMMIT_MSG="chore: update NuGet packages

          Automated NuGet package updates by NugetUpdateBot

          Generated on: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            git commit -m "$COMMIT_MSG"
            git push origin "${{ env.branch }}"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.scan.outputs.updates_available == 'true' && steps.commit.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "ðŸ”„ Update NuGet Packages" \
            --body "## NuGet Package Updates

          This PR contains automatic NuGet package updates generated by dotnet-outdated-tool.

          ### Changes
          - Updated outdated NuGet packages to their latest versions
          - All updates follow semantic versioning best practices

          ### Testing
          Please review the changes and ensure:
          - [ ] All tests pass
          - [ ] No breaking changes introduced
          - [ ] Application builds successfully

          ### Generated Information
          - **Date**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          - **Triggered by**: GitHub Actions (Scheduled)
          - **Tool**: [dotnet-outdated-tool](https://github.com/dotnet-outdated/dotnet-outdated)

          ---
          ðŸ¤– This PR was automatically created by GitHub Actions" \
            --base main \
            --head "${{ env.branch }}"

      - name: No updates needed
        if: steps.scan.outputs.updates_available == 'false'
        run: |
          echo "âœ… All packages are up to date!"
